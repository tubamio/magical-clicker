<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Magical Clicker</title>
  <link rel="stylesheet" href="./style.css" />
</head>
<body>
  <!-- HUD -->
  <div class="hud" id="hud">
    <div class="hud__item">所持魔力 <strong id="powerText">0</strong><small>Power</small></div>
    <div class="hud__item">毎秒 <strong id="ppsText">0</strong><small>PPS</small></div>
    <div class="hud__item"><span class="chip">Ver <span id="verText">0.1.x</span></span></div>
  </div>

  <div class="app">
    <div>
      <div class="panel" id="clickPanel">
        <div class="panel__title">タップ強化 <span class="chip">x4 / 1.03</span></div>
        <div class="row">
          <button class="btn btn-buy" id="tapButton">タップ！</button>
          <div class="card col">
            <div class="kv"><div>現在Lv</div><strong id="clickLvText">0</strong></div>
            <div class="meta">
              <span>いまの威力: <b id="clickPowerNow">1</b></span>
              <span>次Lv効果: <b id="clickPowerNext">×4</b> <span class="diff-plus" id="clickDelta"></span></span>
              <span>次Lv費用: <b id="clickNextCost">125</b></span>
            </div>
          </div>
          <div class="row">
            <button class="btn btn-upg" id="clickUp1">強化 +1</button>
            <button class="btn btn-upg btn-max" id="clickUpMax">最大強化</button>
          </div>
        </div>
      </div>

      <div class="panel" id="genPanel">
        <div class="panel__title">ジェネレーター</div>
        <div class="row th">
          <div class="col">名前</div>
          <div class="col">所持</div>
          <div class="col">出力</div>
          <div class="col">購入</div>
          <div class="col">強化</div>
        </div>
        <div id="genList" class="table"></div>
      </div>
    </div>

    <div>
      <div class="panel" id="prestigePanel">
        <div class="panel__title">転生 <span class="chip">準備中</span></div>
        <div class="meta">転生報酬や条件は今後実装予定だよ。</div>
        <div class="hr"></div>
        <button class="btn btn-ghost" id="hardReset">ハードリセット</button>
      </div>

      <div class="panel">
        <div class="panel__title">システム</div>
        <div class="meta">セーブ/ロード・表記ルールの切替など。</div>
        <div class="row">
          <button class="btn btn-ghost" id="saveBtn">セーブ</button>
          <button class="btn btn-ghost" id="loadBtn">ロード</button>
          <button class="btn btn-ghost" id="resetBtn">セーブ消去</button>
        </div>
      </div>
    </div>
  </div>

  <div class="footer">Magical Clicker — pastel魔法少女UI ✨</div>

  <!-- 必ず相対パス & ES Modules -->
  <script type="module">
    import { wireUIEvents, renderHud, renderClickPanel, renderGenerators } from './js/ui.js';
    import * as economy from './js/economy.js';
    import { GENERATORS as data } from './js/data.js';
    import { fmt, setFormatMode } from './js/format.js'; // 修正版

    // グローバルにフォーマッタを渡す場合
    window.formatJP = fmt;
    setFormatMode('jp');

    // 簡易ステート（実プロジェクトの実体に合わせてね）
    const state = window._state || {
      power: 0,
      clickLv: 0,
      gens: data.map(()=>({count:0, level:0})),
      pps: 0,
    };

    function recalcPPS(){
      const total = data.reduce((sum, _g, i)=>{
        const lvl = state.gens[i].level;
        const owned = state.gens[i].count;
        return sum + economy.genOutput(i, lvl) * owned;
      }, 0);
      state.pps = total;
    }

    function renderAll(){
      recalcPPS();
      renderHud(state);
      renderClickPanel(state, economy);
      renderGenerators(state, economy, data);
      document.getElementById('verText').textContent = '0.1.x';
    }

    // 簡易ディスパッチャ（既存のロジックに合わせて差し替えてOK）
    function dispatch(action){
      if(action.type === 'tap'){
        state.power += Math.max(1, economy.clickPower(state.clickLv));
      }
      if(action.type === 'clickUp'){
        const n = action.n === 'max' ? economy.maxAffordableClick(state.power, state.clickLv) : 1;
        for(let i=0;i<n;i++){
          const cost = economy.clickCost(state.clickLv);
          if(state.power < cost) break;
          state.power -= cost;
          state.clickLv += 1;
        }
      }
      if(action.type === 'genBuy'){
        const idx = action.idx;
        const n = action.n === 'max' ? economy.maxAffordableBuy(idx, state.power, state.gens[idx].count) : 1;
        let bought = 0;
        for(let i=0;i<n;i++){
          const cost = economy.genCost(idx, state.gens[idx].count);
          if(state.power < cost) break;
          state.power -= cost;
          state.gens[idx].count += 1;
          bought++;
        }
      }
      if(action.type === 'genUp'){
        const idx = action.idx;
        const n = action.n === 'max' ? economy.maxAffordableUp(idx, state.power, state.gens[idx].level) : 1;
        for(let i=0;i<n;i++){
          const cost = economy.genUpCost(idx, state.gens[idx].level);
          if(state.power < cost) break;
          state.power -= cost;
          state.gens[idx].level += 1;
        }
      }
      if(action.type === 'save'){ window.localStorage.setItem('mc.save', JSON.stringify(state)); }
      if(action.type === 'load'){ Object.assign(state, JSON.parse(window.localStorage.getItem('mc.save')||'{}')); }
      if(action.type === 'clearSave'){ window.localStorage.removeItem('mc.save'); }
      if(action.type === 'hardReset'){ Object.assign(state, {power:0, clickLv:0, gens: data.map(()=>({count:0,level:0}))}); }

      renderAll();
    }

    wireUIEvents(dispatch);
    renderAll();

    // requestAnimationFrameで加算
    let last = performance.now();
    function tick(now){
      const dt = Math.max(0, (now - last)/1000);
      last = now;
      state.power += (state.pps || 0) * dt;
      if((now|0) % 200 === 0) renderHud(state); // 軽量更新
      requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);
  </script>
</body>
</html>
